---
title: "Durham Misdemeanor: EDA"
author: "Albert Sun"
date: "11/30/2020"
output: 
  pdf_document:
    latex_engine: xelatex
---
```{r echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE,
                      fig.width = 6, 
                      fig.height = 4)
library(tidyverse)
library(skimr)
library(here)
library(zoo)
```

```{r}
misdemeanor <- read_csv(here("../misdemeanor_data.csv")) %>% 
  filter(COUNTY == 310)
```

```{r sort columns alpha}
misdemeanor <- misdemeanor %>% 
  select(sort(current_vars())) 
```

```{r}
skim(misdemeanor)
```
 
# Demographics

Here are three graphs showing race, gender, and age for Misdemeanor Convictions in 2019. The NC Setencing Commissions' dataset is limited up until 2019-06-11, so these graphs only contain data for the first half of 2019. The dates refer to the sentence date of the most serious offense, not necessarily when the offense occurred. As such, these visualizations are meant to focus on the effects of how the Durham legal system has adjudicated these crimes. 

COMPARE THESE JAIL DEMOGRAPHIC NUMBERS TO POPULATION DEMOGRAPHIC NUMBERS

```{r race}
misdemeanor %>%
  filter(sentsas > "2019-01-01") %>%
  ggplot(aes(x = forcats::fct_infreq(race))) + 
  geom_bar(fill = "#23356D") + 
  labs(x = "Race",
       y = "Count",
       title = "Race for Durham County Misdemeanor Convictions, 2019",
       caption = "2019-01-01 to 2019-06-28") + 
  scale_x_discrete(labels = c('Black','White','Hispanic','Other','American Indian','Unknown','Asian')) + 
  theme_minimal() +
  theme(axis.title.x=element_blank())
```

```{r gender}
misdemeanor %>%
  filter(sentsas > "2019-01-01") %>%
  ggplot(aes(x = forcats::fct_infreq(gender))) + 
  geom_bar(fill = "#23356D") + 
  labs(x = "Gender",
       y = "Count",
       title = "Gender for Durham County Misdemeanor Convictions, 2019",
       caption = "2019-01-01 to 2019-06-28") + 
  scale_x_discrete(labels = c('Male','Female')) + 
  theme_minimal() +
  theme(axis.title.x=element_blank())
```

```{r age}
misdemeanor %>%
  filter(sentsas > "2019-01-01") %>%
  ggplot(aes(x = age)) + 
  geom_density(binwidth = 1, fill = "#23356D") +
  labs(title = "Age for Durham County Misdemeanor Convictions, 2019",
       caption = "2019-01-01 to 2019-06-28") + 
  labs(x = "Age") +
  theme_minimal()
```

```{r}
misdemeanor %>%
  filter(sentsas > "2019-01-01") %>%
  summarise(mean_age = mean(age, na.rm = TRUE),
            median_age = median(age, na.rm = TRUE))
```

The median age of receiving a misdemeanor conviction in the first half of 2019 is 32 years.

# Pleas

```{r types of plea}
misdemeanor %>%
  filter(sentsas > "2019-01-01") %>%
  ggplot(aes(x = forcats::fct_infreq(PLEA))) + 
  geom_bar(fill = "#23356D") + 
  labs(x = "Plea Type",
       y = "Count",
       title = "Plea Types for Durham County Misdemeanor Convictions, 2019",
       caption = "2019-01-01 to 2019-06-28") + 
  scale_x_discrete(labels = c('Guilty','Guilty to lesser','Guilty Alford','No Contest','Not Guilty')) + 
  theme_minimal()
```

# Time-series Graphs

In the first 6 months of Satana Deberry's term as Durham County District Attorney, 

```{r mean_last_6_echols}
misdemeanor %>%
  filter(sentsas > "2018-01-01" & sentsas < "2019-01-01") %>%
  mutate(yrmn = as.factor(as.yearmon(sentsas))) %>%
  group_by(yrmn) %>%
  summarise(cnt = n()) %>%
  summarise(mean_last_6_echols = mean(cnt))
```

```{r mean_first 6 satana}
misdemeanor %>%
  filter(sentsas > "2018-06-01") %>%
  mutate(yrmn = as.factor(as.yearmon(sentsas))) %>%
  group_by(yrmn) %>%
  summarise(cnt = n()) %>%
  summarise(mean_first_6_satana = mean(cnt))
```



```{r}
misdemeanor %>%
  filter(sentsas > "2018-01-01") %>%
  mutate(yrmn = as.factor(as.yearmon(sentsas))) %>%
  group_by(yrmn) %>%
  summarise(cnt = n()) %>%
  ggplot(aes(x = yrmn, y = cnt, group = 1)) +
  geom_line(stat = "identity", size = 1.5, color = "#23356D") +
  labs(x = "Month",
       y = "Total Misdemeanor Convictions",
       title = "Total Misdemeanor Convictions per Month in Durham County",
       subtitle = "Satana Deberry (D) replaces incumbent Roger Echols (D) as Durham County District 
Attorney in Jan 2019") + 
  theme_minimal() + 
  geom_vline(aes(xintercept = which(levels(yrmn) %in% 'Jan 2019')),
             color = "blue", size=1.5) + 
  annotate("label", x = 5, y = 70,
           label = "Echols", 
           size = 8, 
           color = "blue", 
           fontface = 2) +
  annotate("label", x = 15.5, y = 70, 
           label = "Deberry", 
           size = 8, 
           color = "blue", 
           fontface = 2) +
  ylim(0, 140) +
  theme(axis.text.x=element_text(angle = -90, hjust = 0), 
        axis.title.x=element_blank())
```

NOTE: For the following graph, the count for 2019 only includes the first half of 2019, because the dataset ends at 2019-06-11.

Misdemeanor convictions have been decreasing yearly in Durham County; they are 
projected to continue decreasing going into 2019 based on this data. Note: the total misdemeanor counts for FY 2019 as shown on the graph isn't fully representative of the *entire* FY 2019, but rather only convictions sentenced up until 2019-06-28, due to the limitations of the existing dataset.

```{r}
misdemeanor <- misdemeanor %>% 
  mutate(crimetype = as.factor(crimetype)) 

misdemeanor$crimetype <- factor(misdemeanor$crimetype, levels=c("1", "2", "3", "4"), 
                                labels=c("Person", "Property", "Drug (Non Trafficking)", "Other"))

misdemeanor %>%
  filter(sentsas > "2009-06-30") %>%
  mutate(yrmn = as.yearmon(sentsas)) %>%
  group_by(FY) %>%
  count(crimetype) %>%
  ungroup %>%
  mutate(crimetype = as.factor(crimetype)) %>%
  ggplot(aes(x = FY, y = n, group = crimetype)) + 
  geom_line() +
  geom_point(aes(shape = crimetype)) + 
  scale_color_manual(values = c("#23356D", "red", "green", "black")) +
  theme_minimal() + 
  theme(axis.text.x=element_text(angle = -90, hjust = 0),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="bottom",
        legend.title=element_blank())  +
  labs(title = "Misdemeanor Convictions by Type of Offense",
       caption = "Note: FY 2019 only runs through cases sentenced before 2019-06-28") 
```

# Fines

The proportion about people fined are about the same across time.

```{r}
durham_1819 <- misdemeanor %>%
  filter(sentsas > "2018-01-01")

durham_1819 %>%
  mutate(year = factor(if_else(sentsas > "2019-01-01", 2019, 2018))) %>%
  mutate(fineflag = factor(durham_1819$"_fineflag")) %>%
  group_by(year) %>%
  count(fineflag) %>%
  ggplot(aes(x = year, y = n, fill = fineflag)) + 
  geom_bar(position="fill", stat="identity") 
```

include other years

Look at fines using race and gender

# Look at next:

+ Fine imposed

+ Add place showing where santana deberry is elected

+ Add images: https://stackoverflow.com/questions/9917049/inserting-an-image-to-ggplot2

Plots to add: 

+ Top 5 misemeanor convictions by offense

+ Convictions by type of offense (Person, Property, Drug, Public Order)

+ Interaction between race and actual sentence